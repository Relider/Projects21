## Part 1. Инструмент **ipcalc**
- Поднять виртуальную машину
## 1.1. Сети и маски
1) адрес сети *192.167.38.54/13* - 192.160.0.0  
![1.png](/src/screenshots/1.PNG)
2) перевод маски *255.255.255.0* в префиксную - /24 и двоичную запись - 11111111.11111111.11111111.00000000  
![2.png](/src/screenshots/2.PNG)
- */15* в обычную - 255.254.0.0 и двоичную - 11111111.11111110.00000000.00000000  
![3.png](/src/screenshots/3.PNG)
- *11111111.11111111.11111111.11110000* в обычную = 255.255.255.240 и префиксную - /28  
![4.png](/src/screenshots/4.PNG)
3) минимальный и максимальный хост в сети *12.167.38.4* при масках: */8*  
![5.png](/src/screenshots/5.PNG)
- *11111111.11111111.00000000.00000000*  
![6.png](/src/screenshots/6.PNG)
- *255.255.254.0*  
![7.png](/src/screenshots/7.PNG)
- */4*  
![8.png](/src/screenshots/8.PNG)
## 1.2. localhost
- Определить и записать в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: 
- *194.34.23.100* - нет
- *127.0.0.2* - да  
![15.png](/src/screenshots/15.PNG)
- *127.1.0.1* - да  
![15.png](/src/screenshots/15.PNG)
- *128.0.0.1* - нет
## 1.3. Диапазоны и сегменты сетей
1) какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: 
- *10.0.0.45* - private  
![10.png](/src/screenshots/10.PNG)
- *134.43.0.2* - public
- *192.168.4.2* - private  
![11.png](/src/screenshots/11.PNG)
- *172.20.250.4* - private  
![12.png](/src/screenshots/12.PNG)
- *172.0.2.1* - public
- *192.172.0.1* - public
- *172.68.0.2* - public
- *172.16.255.255* - private  
![13.png](/src/screenshots/13.PNG)
- *10.10.10.10* - private  
![14.png](/src/screenshots/14.PNG)
- *192.169.168.1* - public
2) какие из перечисленных IP адресов шлюза возможны у сети *10.10.0.0/18*:   
![9.png](/src/screenshots/9.PNG)
- *10.0.0.1* - нет, *10.10.0.2* - да, *10.10.10.10* - да, *10.10.100.1* - нет, *10.10.1.255* - да.
## Part 2. Статическая маршрутизация между двумя машинами
- Поднять две виртуальные машины
- С помощью команды `ip a` посмотреть существующие сетевые интерфейсы
- ws 1  
![16.png](/src/screenshots/16.PNG)
- ws 2  
![17.png](/src/screenshots/17.PNG)
- Описать сетевой интерфейс, соответствующий внутренней сети
- lo - это локальная петля, которая предназначена для сетевого доступа к своему же компьютеру. 
-  на обеих машинах и задать следующие адреса и маски:
- ws1 - *192.168.100.10*, маска */16*  
![17_1.png](/src/screenshots/17_1.PNG)
- ws2 - *172.24.116.8*, маска */12*  
![17_2.png](/src/screenshots/17_2.PNG)
- Выполнить команду `netplan apply` для перезапуска сервиса сети
## 2.1. Добавление статического маршрута вручную
- Добавить статический маршрут от одной машины до другой и обратно при помощи команды вида `ip r add`
- ws1  
![18_1.png](/src/screenshots/18_1.PNG)
- ws2  
![18_2.png](/src/screenshots/18_2.PNG)
- Пропинговать соединение между машинами
- ws1  
![19_1.png](/src/screenshots/19_1.PNG)
- ws2  
![19_2.png](/src/screenshots/19_2.PNG)
## 2.2. Добавление статического маршрута с сохранением
- Перезапустить машины
- Добавить статический маршрут от одной машины до другой с помощью файла *etc/netplan/00-installer-config.yaml*
- ws1  
![20_1.png](/src/screenshots/20_1.PNG)
- ws2  
*![20_2.png](/src/screenshots/20_2.PNG)*
- Пропинговать соединение между машинами
- ws1  
*![21_1.png](/src/screenshots/21_1.PNG)*
- ws2  
*![21_2.png](/src/screenshots/21_2.PNG)*
## Part 3. Утилита **iperf3**
## 3.1. Скорость соединения
- Перевести и записать в отчёт: 8 Mbps = 8 MB/s, 100 MB/s = 102400 Kbps, 1 Gbps = 1024 Mbps
## 3.2. Утилита **iperf3**
- Измерить скорость соединения между ws1 и ws2
- для начала скачиваем iperf3: `sudo aot install iperf3`
- на одном устройстве включаем сервер  
*![23_1.png](/src/screenshots/23_1.PNG)*
- на другом подключаемся к нему  
*![23_2.png](/src/screenshots/23_2.PNG)*
## Part 4. Сетевой экран
## 4.1. Утилита **iptables**
- Создать файл */etc/firewall.sh*, имитирующий фаерволл, на ws1 и ws2:
- Нужно добавить в файл подряд следующие правила:
1) на ws1 применить стратегию когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5)
2) на ws2 применить стратегию когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5)
3) открыть на машинах доступ для порта 22 (ssh) и порта 80 (http)
4) запретить *echo reply* (машина не должна "пинговаться”, т.е. должна быть блокировка на OUTPUT)
5) разрешить *echo reply* (машина должна "пинговаться")
- ws1  
*![22_1.png](/src/screenshots/22_1.PNG)*
- ws2  
*![22_2.png](/src/screenshots/22_2.PNG)*
- Запустить файлы на обеих машинах командами `chmod +x /etc/firewall.sh` и `/etc/firewall.sh`
- ws1  
*![24_1.png](/src/screenshots/24_1.PNG)*
- ws2  
*![24_2.png](/src/screenshots/24_2.PNG)*
- На второй машине можно не выполнять 3 пункт, из-за начальных условий, по той-же причине на первой машине можно не выполнять 4 пункт
## 4.2. Утилита **nmap**
- Командой **ping** найти машину, которая не "пингуется", после чего утилитой **nmap** показать, что хост машины запущен  
*![25.png](/src/screenshots/25.PNG)*
- Сохранить дампы образов виртуальных машин  
*![26.png](/src/screenshots/26.PNG)*
## Part 5. Статическая маршрутизация сети
- Поднять пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2))
## 5.1. Настройка адресов машин
- Настроить конфигурации машин в *etc/netplan/00-installer-config.yaml* согласно сети на рисунке.
- ws11  
*![27_1.png](/src/screenshots/27_1.PNG)*
- ws21  
*![27_2.png](/src/screenshots/27_2.PNG)*
- ws22  
*![27_3.png](/src/screenshots/27_3.PNG)*
- r1  
*![27_4.png](/src/screenshots/27_4.PNG)*
- r2  
*![27_5.png](/src/screenshots/27_5.PNG)*
- Перезапустить сервис сети `sudo netplan apply`. 
- Если ошибок нет, то командой `ip -4 a` проверить, что адрес машины задан верно.
- ws11  
*![28_1.png](/src/screenshots/28_1.PNG)*
- ws21  
*![28_2.png](/src/screenshots/28_2.PNG)*
- ws22  
*![28_3.png](/src/screenshots/28_3.PNG)*
- r1  
*![28_4.png](/src/screenshots/28_4.PNG)*
- r2  
*![28_5.png](/src/screenshots/28_5.PNG)*
- Также пропинговать ws22 с ws21.   
*![29_1.png](/src/screenshots/29_1.PNG)*
- Аналогично пропинговать r1 с ws11.  
*![29_2.png](/src/screenshots/29_2.PNG)*
## 5.2. Включение переадресации IP-адресов.
- Для включения переадресации IP, выполните команду на роутерах: `sysctl -w net.ipv4.ip_forward=1`
- Откройте файл */etc/sysctl.conf* и добавьте в него следующую строку: `net.ipv4.ip_forward = 1`
- r1
*![30_1.png](/src/screenshots/30_1.PNG)*
- r2
*![30_2.png](/src/screenshots/30_2.PNG)*
## 5.3. Установка маршрута по-умолчанию
- Настроить маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавить `default` перед IP роутера в файле конфигураций
- ws11
*![31_1.png](/src/screenshots/31_1.PNG)*
- ws21
*![31_2.png](/src/screenshots/31_2.PNG)*
- ws22
*![31_3.png](/src/screenshots/31_3.PNG)*
- Вызвать `ip r` и показать, что добавился маршрут в таблицу маршрутизации
- ws11
*![32_1.png](/src/screenshots/32_1.PNG)*
- ws21
*![32_2.png](/src/screenshots/32_2.PNG)*
- ws22
*![32_3.png](/src/screenshots/32_3.PNG)*
- Пропинговать с ws11 роутер r2 и показать на r2, что пинг доходит. Для этого использовать команду: `tcpdump -tn -i eth1`
- ws11
*![33.png](/src/screenshots/33.PNG)*
- r2
*![33_1.png](/src/screenshots/33_1.PNG)*
## 5.4. Добавление статических маршрутов
- Добавить в роутеры r1 и r2 статические маршруты в файле конфигураций.
- r1  
*![34_1.png](/src/screenshots/34_1.PNG)*
- r2  
*![34_2.png](/src/screenshots/34_2.PNG)*
- Вызвать `ip r` и показать таблицы с маршрутами на обоих роутерах.
- r1  
*![35_1.png](/src/screenshots/35_1.PNG)*
- r2  
*![35_2.png](/src/screenshots/35_2.PNG)*
- Запустить команды на ws11: `ip r list 10.10.0.0/[маска сети]` и `ip r list 0.0.0.0/0`  
*![36.png](/src/screenshots/36.PNG)*
- Для адреса 10.10.0.0/18 был выбран маршрут, отличный от 0.0.0.0/0, так как последний воспринимается как все возможные адреса, а для первого был найден точный адрес.
## 5.5. Построение списка маршрутизаторов
- Запустить на r1 команду дампа: `tcpdump -tnv -i eth0`
- При помощи утилиты **traceroute** построить список маршрутизаторов на пути от ws11 до ws21
- ws11
*![37_1.png](/src/screenshots/37_1.PNG)*
- r1
*![37_1.png](/src/screenshots/37_1.PNG)*
- **traceroute** для определегия промежуточных маршрутизаторов делает две вещи: 1) изменяет TTL на 1 при неудаче и 2) измеряет время, которое понадобилось на отклик. Так происходит , пока не мы не дойдём до нужного узла.
## 5.6. Использование протокола **ICMP** при маршрутизации
- Запустить на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды: `tcpdump -n -i eth0 icmp`
- Пропинговать с ws11 несуществующий IP (например, *10.30.0.111*) с помощью команды: `ping -c 1 10.30.0.111`
- ws11
*![38_1.png](/src/screenshots/38_1.PNG)*
- r1
*![38_2.png](/src/screenshots/38_2.PNG)*
- Сохранить дампы образов виртуальных машин
## Part 6. Динамическая настройка IP с помощью **DHCP**
- Для r2 настроить в файле */etc/dhcp/dhcpd.conf* конфигурацию службы **DHCP**:
1) указать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети.  
*![39_1.png](/src/screenshots/39_1.PNG)*
2) в файле *resolv.conf* прописать `nameserver 8.8.8.8.`  
*![39_2.png](/src/screenshots/39_2.PNG)*
- Перезагрузить службу **DHCP** командой `systemctl restart isc-dhcp-server`.   
*![40.png](/src/screenshots/40.PNG)*
- Машину ws21 перезагрузить при помощи `reboot` и через `ip a` показать, что она получила адрес.  
*![41.png](/src/screenshots/41.PNG)*
- Также пропинговать ws22 с ws21.  
*![42.png](/src/screenshots/42.PNG)*
- Указать MAC адрес у ws11, для этого в *etc/netplan/00-installer-config.yaml* надо добавить строки: `macaddress: 10:10:10:10:10:BA`, `dhcp4: true`
*![43.png](/src/screenshots/43.PNG)*
- также устанавливаем такой MAC адрес в virtual-box
*![44.png](/src/screenshots/44.PNG)*
- Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11):
1) указать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети с привязкой к MAC адресу.  
*![45.png](/src/screenshots/45.PNG)*
2) в файле *resolv.conf* прописать `nameserver 8.8.8.8.`  
![46.png](/src/screenshots/46.PNG)
- Перезагрузить службу **DHCP** командой `systemctl restart isc-dhcp-server`.   
*![47.png](/src/screenshots/47.PNG)*
- Машину ws21 перезагрузить при помощи `reboot` и через `ip a` показать, что она получила адрес.  
*![48.png](/src/screenshots/48.PNG)*
- Также пропинговать ws22 с ws21.  
*![49.png](/src/screenshots/49.PNG)*
- Запросить с ws21 обновление ip адреса
- ip до   
*![50.png](/src/screenshots/50.PNG)*
- используемые команды и ip после обновления.  
*![53.png](/src/screenshots/53.PNG)*
- dhclient -r удаляет присвоенный ip, а dhclient присваивает
- Сохранить дампы образов виртуальных машин
## Part 7. **NAT**
- В файле */etc/apache2/ports.conf* на ws22 и r1 изменить строку `Listen 80` на `Listen 0.0.0.0:80`, то есть сделать сервер Apache2 общедоступным
- ws22  
![54.png](/src/screenshots/54.PNG)
- r1  
![54_1.png](/src/screenshots/54_1.PNG)
- Запустить веб-сервер Apache командой `service apache2 start` на ws22 и r1
- ws22  
![55.png](/src/screenshots/55.PNG)
- r1  
![55_1.png](/src/screenshots/55_1.PNG)
- Добавить в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:
1) удаление правил в таблице filter - `iptables -F`
2) удаление правил в таблице "NAT" - `iptables -F -t nat`
3) отбрасывать все маршрутизируемые пакеты - `iptables --policy FORWARD DROP`  
![56.png](/src/screenshots/56.PNG)
- Запускать файл также, как в Части 4  
![57.png](/src/screenshots/57.PNG)
- Проверить соединение между ws22 и r1 командой `ping`  
![58.png](/src/screenshots/58.PNG)
- Добавить в файл ещё одно правило:
4) разрешить маршрутизацию всех пакетов протокола **ICMP**  
![59.png](/src/screenshots/59.PNG)
- Запускать файл также, как в Части 4  
![60.png](/src/screenshots/60.PNG)
- Проверить соединение между ws22 и r1 командой `ping`  
![61.png](/src/screenshots/61.PNG)
- Добавить в файл ещё два правила:
5) включить **SNAT**, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)
6) включить **DNAT** на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети  
![62.png](/src/screenshots/62.PNG)
- Запускать файл также, как в Части 4  
![60.png](/src/screenshots/60.PNG)
- Проверить соединение по TCP для **SNAT**, для этого с ws22 подключиться к серверу Apache на r1 командой: `telnet [адрес] [порт]`  
![63.png](/src/screenshots/63.PNG)
- Проверить соединение по TCP для **DNAT**, для этого с r1 подключиться к серверу Apache на ws22 командой `telnet` (обращаться по адресу r2 и порту 8080)  
![64.png](/src/screenshots/64.PNG)
- Сохранить дампы образов виртуальных машин
## Part 8. Дополнительно. Знакомство с **SSH Tunnels**
- Запустить на r2 фаервол с правилами из Части 7  
![62.png](/src/screenshots/62.PNG)
- Запустить веб-сервер **Apache** на ws22 только на localhost (то есть в файле */etc/apache2/ports.conf* изменить строку `Listen 80` на `Listen localhost:80`)  
![65.png](/src/screenshots/65.PNG)  
![66.png](/src/screenshots/66.PNG)
- подтверждаем
- Воспользоваться *Local TCP forwarding* с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21
- устанавливаем ssh c помощью команды `sudo apt install ssh`
- подключаем порт 80 удалённого порта 9999 к порту 80 на удалённой машине  
![67.png](/src/screenshots/67.PNG)  
![68.png](/src/screenshots/68.PNG)
- Воспользоваться *Remote TCP forwarding* c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11
- подключаем порт 80 удалённого хоста к порту 9999 на машине  
![71.png](/src/screenshots/71.PNG)  
![72.png](/src/screenshots/72.PNG)
- Для проверки, сработало ли подключение в обоих предыдущих пунктах, перейдите во второй терминал (например, клавишами Alt + F2) и выполните команду: `telnet 127.0.0.1 [локальный порт]`
- ws22  
![73.png](/src/screenshots/73.PNG)
- ws21  
![74.png](/src/screenshots/74.PNG)
- Сохранить дампы образов виртуальных машин